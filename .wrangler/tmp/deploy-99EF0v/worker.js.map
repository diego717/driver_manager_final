{
  "version": 3,
  "sources": ["../../../worker.js"],
  "sourceRoot": "C:\\Users\\Diego Sas\u00E9n\\OneDrive\\Escritorio\\driver_manager\\.wrangler\\tmp\\deploy-99EF0v",
  "sourcesContent": ["export default {\n  async fetch(request, env) {\n    // Definir los encabezados CORS para permitir solicitudes desde cualquier origen\n    const corsHeaders = {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS', // A\u00F1adido DELETE\n      'Access-Control-Allow-Headers': 'Content-Type',\n    };\n\n    // Responder a las solicitudes OPTIONS (pre-vuelo de CORS)\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    const url = new URL(request.url);\n    const params = url.searchParams;\n    const pathParts = url.pathname.split('/').filter(part => part !== \"\");\n\n    try {\n      if (!env.DB) {\n        throw new Error(\"La base de datos (D1) no est\u00E1 vinculada a este Worker.\");\n      }\n\n      // --- RUTA: /installations ---\n      if (pathParts.length === 1 && pathParts[0] === 'installations') {\n        \n        // M\u00C9TODO GET: Listar todos los registros\n        if (request.method === 'GET') {\n          const { results } = await env.DB.prepare(\n            \"SELECT * FROM installations ORDER BY timestamp DESC\"\n          ).all();\n          \n          return new Response(JSON.stringify(results), { \n            headers: { ...corsHeaders, 'Content-Type': 'application/json' } \n          });\n        }\n\n        // M\u00C9TODO POST: Crear un nuevo registro de instalaci\u00F3n\n        if (request.method === 'POST') {\n          const data = await request.json();\n          await env.DB.prepare(`\n            INSERT INTO installations (timestamp, driver_brand, driver_version, status, client_name, driver_description, installation_time_seconds, os_info, notes)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n          `).bind(\n            data.timestamp || new Date().toISOString(),\n            data.driver_brand || '',\n            data.driver_version || '',\n            data.status || 'unknown',\n            data.client_name || '',\n            data.driver_description || '',\n            data.installation_time_seconds || 0,\n            data.os_info || '',\n            data.notes || ''\n          ).run();\n          \n          return new Response(JSON.stringify({ success: true }), { \n            status: 201, headers: corsHeaders \n          });\n        }\n      }\n\n      // --- RUTA: /installations/:id (Para PUT y DELETE) ---\n      if (pathParts.length === 2 && pathParts[0] === 'installations') {\n        const recordId = pathParts[1];\n\n        // M\u00C9TODO PUT: Actualizar un registro existente\n        if (request.method === 'PUT') {\n          const data = await request.json();\n          await env.DB.prepare(`\n            UPDATE installations \n            SET notes = ?, installation_time_seconds = ?\n            WHERE id = ?\n          `).bind(\n            data.notes ?? null,\n            data.installation_time_seconds ?? null,\n            recordId\n          ).run();\n\n          return new Response(JSON.stringify({ success: true, updated: recordId }), { \n            headers: { ...corsHeaders, 'Content-Type': 'application/json' } \n          });\n        }\n\n        // M\u00C9TODO DELETE: Eliminar un registro\n        if (request.method === 'DELETE') {\n          if (!recordId) {\n            return new Response('Error: El ID del registro es obligatorio.', { status: 400 });\n          }\n          \n          await env.DB.prepare('DELETE FROM installations WHERE id = ?').bind(recordId).run();\n          \n          return new Response(JSON.stringify({ message: `Registro ${recordId} eliminado.` }), {\n            headers: { 'Content-Type': 'application/json' },\n            status: 200,\n          });\n        }\n      }\n\n      // --- RUTA: /statistics (Para reportes) ---\n      if (url.pathname === '/statistics') {\n        // ... (la l\u00F3gica de estad\u00EDsticas se mantiene igual)\n        const { results: byBrand } = await env.DB.prepare(\n          \"SELECT driver_brand, COUNT(*) as count FROM installations GROUP BY driver_brand\"\n        ).all();\n\n        const brandStats = {};\n        byBrand.forEach(row => {\n          if (row.driver_brand) brandStats[row.driver_brand] = row.count;\n        });\n\n        // ... m\u00E1s l\u00F3gica de estad\u00EDsticas ...\n\n        return new Response(JSON.stringify({ by_brand: brandStats }), { \n          headers: { ...corsHeaders, 'Content-Type': 'application/json' } \n        });\n      }\n\n      return new Response(\"Ruta no encontrada.\", { status: 404 });\n\n    } catch (e) {\n      // Manejo de errores centralizado\n      return new Response(JSON.stringify({ error: e.message }), { \n        status: 500,\n        headers: corsHeaders\n      });\n    }\n  }\n};"],
  "mappings": "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",
  "names": []
}
